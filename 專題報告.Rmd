---
title: "專題製作"
author: "吳忠憲、曾增凱、曾苡嘉"
date: "2024-08-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reticulate)
use_python("C:\\Users\\USER\\anaconda3")
```

#### 安裝套件
```{r}
library(caret)
library(ggplot2)
library(reshape2)
library(superml)
library(parsnip)
library(workflows)
library(baguette)
library(tune)
library(yardstick)
library(rsample)
library(tidymodels)
library(Boruta)
library(party)
library(randomForest)
library(class)
library(highcharter)
```

https://reurl.cc/0dxArA

#### 載入資料集及資料理解

age：患者的年齡

sex：患者的性別

exang：運動引起的心絞痛（1 = 是；0 = 否）

ca：主要血管數量（0-3），當大血管數量夠多，例如4個，罹患心臟病的可能性就很大爬升，甚至比等於 0 的數字高一點點。)

cp : 胸痛型 胸痛型

    值1：典型心絞痛
    值2：非典型心絞痛
    值3：非心絞痛
    值4：無症狀
    
trtbps ：靜止血壓（毫米汞柱）

chol ：透過 BMI 感測器獲取的膽固醇（mg/dl）


fbs ：（空腹血糖 > 120 mg/dl）（1 = 正確；0 = 錯誤）

rest_ecg ：靜止心電圖結果

    值 0：正常
    值 1：ST-T波異常（T波倒置和/或ST抬高或壓低> 0.05 mV）
    值 2：根據 Estes 標準顯示可能或明確的左心室肥厚
    
thalach ：達到的最大心率


SLP: 平坦、下斜或凹陷的 ST 段可能表示冠狀動脈缺血。 ST 段抬高可能提示透壁性心肌梗塞
caa : 指類澱粉(Amyloid)物質沈積在大腦動脈造成的病變
thall：地中海型貧血

output：0 = 心臟病發作的可能性較小 1 = 心臟病發作的可能性較大



```{r echo=FALSE}
heart = read.csv('heart.csv')
dim(heart)
head(heart)
```

```{r echo=FALSE}
sapply(heart, function(x) sum(is.na(x)))
```


#### 數值資料及類別資料區分
```{r}
heart_num<-heart[,c("age","trtbps","chol","thalachh","oldpeak")]
heart_cat <-setdiff(heart,heart_num)
heart_cat <- as.data.frame(heart_cat)

```


#### 正規化
```{r}
normalize <- function(x) {
  return((x - min(x)) / (max(x) - min(x)))
}

# 運用隱式迴圈函數逐欄(含y)正規化後再將等長串列轉為資料框
heart_norm <- as.data.frame(lapply(heart_num, normalize))
```


#### 資料分割


```{r echo=FALSE}
heart_all <- cbind(heart_cat, heart_norm)
heart_all$output <- as.factor(heart_all$output)


```

#### 創建訓練集及測試集

```{r echo=FALSE}

set.seed(456)

inTrain <- createDataPartition(heart_all[,13],
                               p = 0.7,
                               list = FALSE)
heart_train <- heart_all[inTrain,]
heart_test <- heart_all[-inTrain,]
```

#### 分割後資料大小
```{r}
cat('x的訓練集：',dim(heart_train))
cat('\nx的測試集：',dim(heart_test))


```

#### 確認測試集在患有心臟病的人數是否平衡
```{r}
a = table(heart_train$output)
b = barplot(a,col=rainbow(2),main='Class Distribution',ylim = c(0,130),ylab = '樣本數量',xlab = '是否患有心臟病',names.arg = c('無','有'))
text(x=b,y=a+5,labels = a)
prop.table(table(heart_train$output))
```
#### 確認測試集在患有心臟病的人數是否平衡
```{r}
a = table(heart_test$output)
b = barplot(a,col=rainbow(2),main='Class Distribution',ylim = c(0,130),ylab = '樣本數量',xlab = '是否患有心臟病',names.arg = c('無','有'))
text(x=b,y=a+5,labels = a)
prop.table(table(heart_test$output))
```



#### 相關分析圖
```{r}
corrplot::corrplot(cor(heart_train[-9]))

```


#### 迴歸模型
```{R}
model_glm = glm(output ~ . , family="binomial", data = heart_train)
summary(model_glm)
# Predictions on the training set
predictTrain = predict(model_glm, data = heart_train, type = "response")

# Confusion matrix on training data
table(heart_train$output, predictTrain >= 0.5)
# (114+268)/nrow(train) #Accuracy - 91%

#Predictions on the test set
predictTest = predict(model_glm, newdata = heart_test, type = "response")

# Confusion matrix on test set
table(heart_test$output, predictTest >= 0.5)

```




#### 決策樹
```{r}
learn_df <- ctree(output ~ ., data = heart_train, controls=ctree_control(maxdepth=7))

pre_df <- predict(learn_df, heart_test[, -9])
pre_df

cm_ct <- table(round(pre_df), heart_test$output)
cm_ct
plot(learn_df,type="simple")
df_acc <- sum(diag(cm_ct)/sum(cm_ct))
print(paste0("The decision Tree model is ", round(df_acc, digits = 4)*100,"%", " accurate"))
```


#### 隨機森林

```{R}
learn_rf <- randomForest(output~.,data=heart_train,ntree=300,proximity=TRUE,importance=TRUE)
pre_rf <-predict(learn_rf,heart_test[,-9])
cm_rf <- confusionMatrix(pre_rf,heart_test$output)
cm_rf
```

### KNN

```{R}
acc_test <- NULL
set.seed(456)
for (i in 1:15){
  predict <-knn(train=heart_train[,-9],test=heart_test[,-9],cl=heart_train[,9],k=i,prob=TRUE)
  acc_test <- c(acc_test,mean(predict==heart_test[,9]))
}
acc <- data.frame(k = seq(1,15),cnt=acc_test)
opt_k <-subset(acc,cnt==max(cnt))[1,]
sub <-paste0("Optimal number of k is ",opt_k$k," (accuracy :", opt_k$cnt," ) in KNN")
hchart(acc,'line',hcaes(k,cnt)) |>
  hc_title(text='Accuracy With Varying K (KNN)')|>
  hc_subtitle(text = sub) |>
  hc_add_theme(hc_theme_google())|>
  hc_xAxis(title=list(text = 'Numer of Neighbors(k)')) |>
  hc_yAxis(title=list(text = 'Accuracy'))

```



#### 特徵選擇(Boruta)
1. 綠色顯示選定的變量
2. 紅色表示拒絕的變量
3. 藍色為判斷基準的變量
4. 黃色（如果有的話）表示 Boruta 尚未決定該變量。



```{R}

default_br <- Boruta(output ~ ., data = heart_all, doTrace = 2, maxRuns = 250)
plot(default_br, las = 2, cex.axis = 0.7)
# 查看結果摘要
print(default_br)


```